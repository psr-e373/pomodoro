<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pomodoro + TODO</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230aa'/%3E%3Ctext x='32' y='40' font-size='28' text-anchor='middle' fill='white'%3EP%3C/text%3E%3C/svg%3E">
<style>
:root{
  --bg:#0f1115;--panel:#151924;--panel-2:#0f1320;
  --accent:#6ee7ff;--accent-2:#a78bfa;
  --text:#eef2ff;--muted:#94a3b8;--danger:#fb7185;--ok:#34d399;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#0b0e13);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}

/* 共通カード */
.card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1f2739;border-radius:16px;box-shadow:0 12px 24px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.03)}
.card .inner{padding:16px}
.card h2{margin:0 0 8px;font-size:15px;color:#cbd5e1;letter-spacing:.2px}
#todo-card h2{font-size:17px}

/* KPIヘッダー */
header.kpi{max-width:1080px;margin:16px auto 8px;padding:0 16px}
.kpi.card .inner{padding:16px 18px;display:grid;grid-template-columns:1.1fr 1fr;gap:12px;align-items:center}
@media (max-width:900px){.kpi.card .inner{grid-template-columns:1fr}}
.brand{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.brand-title{font-weight:900;letter-spacing:.4px;margin:0;background:linear-gradient(90deg,#eaf2ff,#bfe6ff 60%,#cdb8ff);-webkit-background-clip:text;background-clip:text;color:transparent;font-size:26px;line-height:1}
.badges{display:flex;gap:8px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:#d9e5ff;background:#0f1628;border:1px solid #24314a;border-radius:999px;padding:8px 12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);white-space:nowrap}
.totals{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.kpi-big{font-size:26px;font-weight:900;letter-spacing:.3px}
.kpi-sub{font-size:14px;color:#a8b5cc}
.accent-grad{background:linear-gradient(90deg,rgba(110,231,255,.18),rgba(167,139,250,.18));border-radius:12px;padding:6px 10px;border:1px solid #223049}

/* レイアウト本体 */
main{max-width:1080px;margin:0 auto;padding:8px 16px 24px;display:grid;gap:16px}
.grid{display:grid;grid-template-columns:336px 1fr;gap:16px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}

/* タイマー */
.timer-face{display:grid;place-items:center;padding:12px 16px 4px}
.ring{width:260px;height:260px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(#2a334a var(--p),var(--accent) 0);filter:drop-shadow(0 8px 24px rgba(110,231,255,.25))}
.ring::before{content:"";width:236px;height:236px;border-radius:50%;background:radial-gradient(110% 110% at 50% 0%,#1b2234,#0f1320)}
.time{position:absolute;text-align:center}
.time h3{font-size:44px;margin:0 0 4px}
.phase{font-size:13px;color:#7f8ea8;margin:0}
.focus-title{font-size:20px;font-weight:800;text-align:center;margin:4px 0 8px;color:#e5edff;min-height:28px}
.focus-title.empty{color:#9fb0ca}
.timer-controls{display:flex;gap:8px;justify-content:center;padding:12px 16px 4px;flex-wrap:wrap}
.btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:#212a41;color:#eef2ff;font-weight:600;cursor:pointer;transition:.15s transform,.15s opacity;border:1px solid #2a334a;white-space:nowrap}
.btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
.btn.primary{background:linear-gradient(180deg,#1a2a3e,#122035);border-color:#2c3a52}
.btn.accent{background:linear-gradient(180deg,#1b2f45,#15273f);border-color:#2f3e5c;box-shadow:0 0 0 2px rgba(167,139,250,.15) inset}
.btn.ok{background:linear-gradient(180deg,#14312a,#10261f);border-color:#1c3d33;color:#ccffee}
.btn.danger{background:linear-gradient(180deg,#3a1b25,#2b131b);border-color:#542735;color:#ffdbe3}

.row{display:flex;gap:10px;align-items:center}
.row + .row{margin-top:10px}
input[type="number"],input[type="text"],select{width:100%;background:#0f1422;border:1px solid #24314a;border-radius:10px;padding:10px 12px;color:#dbeafe}
label{font-size:13px;color:#9fb0ca}
.hint{font-size:12px;color:#7c8aa5}

/* 入力エリア */
.todo-input{display:grid;grid-template-columns:minmax(0,8fr) 92px 84px 96px 128px minmax(64px,max-content) max-content;gap:8px;row-gap:6px;align-items:center}
.todo-input>div[aria-hidden="true"]{visibility:hidden}
.ti-label{font-size:16px;color:#cbd5e1;line-height:1.2;margin:0 2px;white-space:nowrap}
.ti-label.bold{font-weight:700;font-size:14px}
.repeat-cell{display:flex;align-items:center;gap:6px;white-space:nowrap}
#todo-repeat{width:84px}
.date-input{width:128px;height:40px;background:#122034;border:1px solid #24314a;border-radius:10px;color:#dbeafe;padding:0 8px;cursor:pointer}
.selected-date-label{font-size:12px;color:#9fb0ca;white-space:nowrap}

/* タブ＆ソート */
.tab{padding:6px 10px;border-radius:999px;border:1px solid #2a334a;background:#0f1628;color:#cbd5e1;font-size:12px;cursor:pointer}
.tab.active{background:#1b2a44;color:#e2e8f0;border-color:#3a4a6b}
.sort-select{background:#0f1422;border:1px solid #24314a;border-radius:10px;color:#dbeafe;padding:8px 10px;font-size:12px}

/* タスクリスト */
.todo-list{list-style:none;margin:0;padding:0}
.todo-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid #22304a;border-radius:12px;background:#101728;overflow:hidden;flex-wrap:wrap}
.todo-item + .todo-item{margin-top:8px}
.todo-item.completed{background:#070b12;border-color:#0f1a2d;filter:saturate(.2) brightness(.55) contrast(1.06)}
.todo-item.completed .todo-title{text-decoration:line-through;color:#7a8699}
.todo-title{flex:1 1 320px;min-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.todo-actions{display:flex;gap:6px;margin-left:auto}
.chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #24314a;background:#0f1628;color:#cbd5e1;white-space:nowrap}
footer{padding:8px 16px 24px;color:#6b7280;text-align:center;font-size:12px}
</style>
</head>
<body>

<header class="kpi">
  <section class="card kpi">
    <div class="inner">
      <div class="brand">
        <h1 class="brand-title">Pomodoro + TODO</h1>
        <div class="badges">
          <span class="badge">⏱ 今日のポモドーロ: <b id="today-pomos">0</b></span>
          <span class="badge">➕ フォーカス合計: <b id="focus-min">0</b>分</span>
          <span class="badge">☑️ タスク: <b id="task-count">0</b></span>
        </div>
      </div>
      <div class="totals">
        <div class="kpi-big accent-grad" id="total-planned"><strong>今日の予定:</strong> 0分</div>
        <div class="kpi-big accent-grad" id="total-focused"><strong>集中済:</strong> 0分</div>
        <div class="kpi-sub">※ 今日の予定＝「日付が今日まで」の未完タスク（過去分も含む）の見積合計</div>
      </div>
    </div>
  </section>
</header>

<main>
  <div class="grid">
    <!-- タイマー -->
    <section class="card" id="timer-card">
      <div class="inner">
        <div id="focus-title" class="focus-title empty">（集中するタスク未選択）</div>
        <h2>タイマー</h2>
        <div class="timer-face">
          <div class="ring" id="ring" style="--p:0deg; position:relative;">
            <div class="time">
              <h3 id="display">25:00</h3>
              <p class="phase" id="phase">集中</p>
            </div>
          </div>
        </div>
        <div class="timer-controls">
          <button class="btn primary" id="btn-start">▶ 集中開始</button>
          <button class="btn" id="btn-pause">⏸ 一時停止</button>
          <button class="btn danger" id="btn-reset">⟲ リセット</button>
          <button class="btn ok" id="btn-skip">⤴ 次のフェーズ</button>
          <button class="btn accent" id="btn-google">🔔 Googleでサインイン</button>
          <button class="btn danger" id="btn-signout" style="display:none;">サインアウト</button>
        </div>
        <div class="row">
          <label style="width:33%">集中 (分)<input type="number" id="len-focus" min="1" value="25"></label>
          <label style="width:33%">短休憩 (分)<input type="number" id="len-short" min="1" value="5"></label>
          <label style="width:34%">長休憩 (分)<input type="number" id="len-long" min="1" value="15"></label>
        </div>
      </div>
    </section>

    <!-- タスクリスト -->
    <section class="card" id="todo-card">
      <div class="inner">
        <h2>タスクリスト</h2>

        <div class="todo-input">
          <div class="ti-label bold">タスク</div>
          <div class="ti-label bold">セット数</div>
          <div class="ti-label bold">繰り返し</div>
          <div class="ti-label" aria-hidden="true"></div>
          <div class="ti-label bold" style="grid-column: span 2;">期日</div>
          <div class="ti-label" aria-hidden="true"></div>

          <input id="todo-input" type="text" placeholder="やること（Enterで見積へ）">
          <input id="todo-est" type="number" min="0" value="0" title="見積セット数" placeholder="見積セット">
          <div class="repeat-cell">
            <input id="todo-repeat" type="number" min="0" value="0" title="繰り返し（日数）" placeholder="0">
            <span class="selected-date-label">日ごと</span>
          </div>
          <div aria-hidden="true"></div>
          <input id="todo-date" type="date" class="date-input" title="予定日を選択">
          <span id="picked-date-label" class="selected-date-label">予定: -</span>
          <button class="btn ok" id="add-todo">追加</button>
        </div>

        <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
          <button type="button" class="tab active" data-tab="all">すべて</button>
          <button type="button" class="tab" data-tab="today">今日</button>
          <button type="button" class="tab" data-tab="tomorrow">明日</button>
          <button type="button" class="tab" data-tab="done">完了済み</button>
          <select id="sort-select" class="sort-select" title="並び替え" style="margin-left:auto">
            <option value="due_asc">ソート: 期限 昇順</option>
            <option value="due_desc">ソート: 期限 降順</option>
            <option value="created">ソート: 追加順</option>
            <option value="title">ソート: タイトル A→Z</option>
            <option value="est_desc">ソート: 見積(セット) 多い順</option>
          </select>
        </div>

        <ul class="todo-list" id="todo-list" style="margin-top:12px"></ul>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="clear-done">完了タスクを非表示</button>
          <button class="btn danger" id="clear-all">未完タスクをすべて削除</button>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>データはブラウザ（localStorage）＆ Googleサインイン時は Firestore に自動保存</footer>

<!-- ===================== アプリ本体 ===================== -->
<script>
const STORE_KEY='pomotodo-state-v1';
const DEFAULTS={settings:{focus:25,short:5,long:15},tasks:[],stats:{todayPomos:0,focusMin:0},_meta:{updatedAt:Date.now()}};
const $=sel=>document.querySelector(sel);

/* 端末共通の安全な日付取得（Safari対応） */
function getDateStrFromInput(el){
  // el.value が "YYYY-MM-DD" ならそのまま、その他は正規化
  if(el && el.value && /^\d{4}-\d{2}-\d{2}$/.test(el.value)) return el.value;
  try{
    const d = el.valueAsDate || new Date(el.value);
    if(!d || isNaN(d.getTime())) return '';
    const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), da=('0'+d.getDate()).slice(-2);
    return `${y}-${m}-${da}`;
  }catch{ return '' }
}

function load(){try{return JSON.parse(localStorage.getItem(STORE_KEY))||structuredClone(DEFAULTS);}catch{return structuredClone(DEFAULTS)}}
let state = load();

function renderAll(){renderTasks();updateKPI();setRing()}

/* ===== タイマー ===== */
let t=null,remain=state.settings.focus*60,phase='集中',cycles=0,running=false;
function fmt(s){const m=Math.floor(s/60),ss=('0'+(s%60)).slice(-2);return `${m}:${ss}`}
function setRing(){const total=(phase==='集中')?state.settings.focus*60:(phase==='短休憩'?state.settings.short*60:state.settings.long*60);const p=360*(1-remain/total);$('#ring').style.setProperty('--p',p+'deg')}
function start(){if(running)return;running=true;t=setInterval(tick,1000)}
function pause(){running=false;clearInterval(t)}
function reset(){pause();phase='集中';remain=state.settings.focus*60;cycles=0;$('#phase').textContent=phase;$('#display').textContent=fmt(remain);setRing()}
function nextPhase(){pause();if(phase==='集中'){cycles++;state.stats.todayPomos++;state.stats.focusMin+=state.settings.focus;phase=(cycles%4===0)?'長休憩':'短休憩';remain=(phase==='長休憩'?state.settings.long:state.settings.short)*60}else{phase='集中';remain=state.settings.focus*60}$('#phase').textContent=phase;$('#display').textContent=fmt(remain);setRing();updateKPI();save()}
function tick(){remain--;if(remain<=0){nextPhase()}$('#display').textContent=fmt(remain);setRing()}
$('#btn-start').onclick=start;$('#btn-pause').onclick=pause;$('#btn-reset').onclick=reset;$('#btn-skip').onclick=nextPhase;
$('#len-focus').oninput=e=>{state.settings.focus=+e.target.value||25;save();reset()};
$('#len-short').oninput=e=>{state.settings.short=+e.target.value||5;save();reset()};
$('#len-long' ).oninput=e=>{state.settings.long =+e.target.value||15;save();reset()};
reset();

/* ===== タスク ===== */
function addTask(){
  const title=$('#todo-input').value.trim(); if(!title) return;
  const est = Number($('#todo-est').value)||0;
  const rep = Number($('#todo-repeat').value)||0;
  const due = getDateStrFromInput($('#todo-date')) || null;

  state.tasks.push({id:crypto.randomUUID(),title,est,repeat:rep,due,done:false,createdAt:Date.now()});
  $('#todo-input').value=''; $('#todo-est').value=0; $('#todo-repeat').value=0; $('#todo-date').value='';
  $('#picked-date-label').textContent='予定: -';
  save();
}
$('#add-todo').onclick=addTask;
$('#todo-input').addEventListener('keydown',e=>{if(e.key==='Enter')$('#todo-est').focus()});
$('#todo-date').addEventListener('change',()=>{
  const s=getDateStrFromInput($('#todo-date'));
  $('#picked-date-label').textContent = '予定: ' + (s||'-');
});

function renderTasks(){
  const tab=document.querySelector('.tab.active')?.dataset.tab||'all';
  const list=$('#todo-list'); list.innerHTML='';
  const todayStr=new Date().toISOString().slice(0,10);

  let tasks=[...state.tasks];
  if(tab==='today') tasks=tasks.filter(t=>!t.done && t.due && t.due<=todayStr);
  if(tab==='tomorrow'){ const d=new Date(); d.setDate(d.getDate()+1); const s=d.toISOString().slice(0,10); tasks=tasks.filter(t=>!t.done&&t.due===s); }
  if(tab==='done') tasks=tasks.filter(t=>t.done);

  const s=$('#sort-select').value;
  const cmp={
    due_asc :(a,b)=>String(a.due||'9999').localeCompare(String(b.due||'9999')),
    due_desc:(a,b)=>String(b.due||'').localeCompare(String(a.due||'')),
    created :(a,b)=>a.createdAt-b.createdAt,
    title   :(a,b)=>a.title.localeCompare(b.title),
    est_desc:(a,b)=>(Number(b.est)||0)-(Number(a.est)||0),
  }[s] || ((a,b)=>0);
  tasks.sort(cmp);

  for(const t of tasks){
    const li=document.createElement('li'); li.className='todo-item'+(t.done?' completed':'');
    const estText = Number(t.est)||0;
    li.innerHTML = `
      <span class="todo-title">${t.title}</span>
      <span class="chip">セット:${estText}</span>
      ${t.due?`<span class="chip">期日:${t.due}</span>`:''}
      <span class="todo-actions">
        <button class="btn ok btn-done">${t.done?'未完':'完了'}</button>
        <button class="btn danger btn-del">削除</button>
      </span>`;
    li.querySelector('.btn-done').onclick=()=>{t.done=!t.done;save()};
    li.querySelector('.btn-del').onclick=()=>{state.tasks=state.tasks.filter(x=>x.id!==t.id);save()};
    list.appendChild(li);
  }
  $('#task-count').textContent=state.tasks.length;
}
document.querySelectorAll('.tab').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderTasks();});
$('#sort-select').onchange=renderTasks;
$('#clear-all').onclick = ()=>{state.tasks=state.tasks.filter(t=>t.done);save()};
$('#clear-done').onclick= ()=>{state.tasks=state.tasks.filter(t=>!t.done);save()};

function updateKPI(){
  $('#today-pomos').textContent = state.stats.todayPomos||0;
  $('#focus-min').textContent  = state.stats.focusMin||0;
  const todayStr=new Date().toISOString().slice(0,10);
  const planned = state.tasks
    .filter(t=>!t.done && t.due && t.due<=todayStr)
    .reduce((a,b)=>a+(Number(b.est)||0)*25,0);
  $('#total-planned').innerHTML = `<strong>今日の予定:</strong> ${planned}分`;
  $('#total-focused').innerHTML = `<strong>集中済:</strong> ${state.stats.focusMin||0}分`;
}

/* すべての保存入口をここに統一（ローカル＋クラウド） */
function save(){
  state._meta={updatedAt:Date.now()};
  try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch{}
  if(window.cloud && cloud.enabled) cloud.saveDebounced(state);
  renderAll();
}

renderAll();
</script>

<!-- ===================== Firebase 同期（Safari対策・デバウンス・無限ループ抑止・サニタイズ） ===================== -->
<script>
(function(){
  const CFG={apiKey:"AIzaSyD1aS6Csj1Cn2_FQ5FrWHlaNuWlPFqmeMs",authDomain:"pomotodo-99d75.firebaseapp.com",projectId:"pomotodo-99d75",appId:"1:466809909425:web:97f9fda37b994d9e4f3290"};
  const SDKS=[
    "https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js",
    "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js",
    "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js",
  ];
  function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s)})}
  function debounce(fn,ms){let id;return(...a)=>{clearTimeout(id);id=setTimeout(()=>fn(...a),ms)}}
  function sanitize(obj){return JSON.parse(JSON.stringify(obj,(_k,v)=>{if(typeof v==='function'||typeof v==='symbol'||typeof v==='bigint')return undefined;if(v===undefined)return null;return v}))}
  const toTs=v=>typeof v==='number'?v:(typeof v==='string'?Date.parse(v):0)||0;
  const deepEq=(a,b)=>{try{return JSON.stringify(a)===JSON.stringify(b)}catch{return false}};

  async function boot(){
    if(!window.firebase||!firebase?.apps){for(const u of SDKS)await loadScript(u)}
    try{ if(!firebase.apps.length) firebase.initializeApp(CFG); }catch{}
    // Safari/ネットワーク制限対策
    try{
      const _db=firebase.firestore();
      _db.settings({
        experimentalAutoDetectLongPolling:true,
        useFetchStreams:false,
        ignoreUndefinedProperties:true
      });
    }catch(e){console.warn('[firestore settings]',e)}
    startSync();
  }

  // cloud 名前空間（saveをアプリ側からも叩けるように）
  window.cloud={enabled:false,saveDebounced:()=>{}};

  function startSync(){
    const auth=firebase.auth(), db=firebase.firestore();
    const who=$('#who'), btnLogin=$('#btn-google'), btnOut=$('#btn-signout');

    if(btnLogin) btnLogin.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    if(btnOut)   btnOut.onclick  =()=>auth.signOut();

    let unsub=null, ref=null;
    const saveCore = async(st)=>{
      try{
        if(!ref) return;
        const clean=sanitize(st);
        await ref.set({state:clean},{merge:true});
      }catch(e){ console.warn('[sync] saveToCloud failed:', e); }
    };
    const saveDebounced = debounce(saveCore, 600);

    auth.onAuthStateChanged(async user=>{
      if(user){
        if(who) who.textContent=`${user.displayName||user.email} でログイン中`;
        if(btnLogin) btnLogin.style.display='none';
        if(btnOut)   btnOut.style.display='';
        ref = db.collection('users').doc(user.uid).collection('apps').doc('pomotodo');
        window.cloud.enabled = true;
        window.cloud.saveDebounced = saveDebounced;

        if(unsub){unsub();unsub=null}
        unsub = ref.onSnapshot(s=>{
          if(!s.exists) return;
          const cloud=s.data()?.state;
          const cTs=toTs(cloud?._meta?.updatedAt), lTs=toTs(state?._meta?.updatedAt);
          if(cloud && (cTs>lTs || !deepEq(cloud,state))){
            state = cloud;
            try{ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }catch{}
            renderAll();
            console.log('[sync] applied cloud → UI', cTs);
          }
        },err=>console.warn('[sync] onSnapshot error:',err));

        // 初回：ローカルがあればアップロード
        if(toTs(state?._meta?.updatedAt)>0) saveDebounced(state);

      }else{
        if(who) who.textContent='未ログイン';
        if(btnLogin) btnLogin.style.display='';
        if(btnOut)   btnOut.style.display='none';
        window.cloud.enabled=false;
        ref=null;
        if(unsub){unsub();unsub=null}
      }
    });
  }

  boot();
})();
</script>
</body>
</html>
